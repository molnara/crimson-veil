CRIMSON VEIL - v0.6.0 IMPLEMENTATION GUIDE (SIMPLIFIED)
========================================================

ðŸŽ® DESIGN PHILOSOPHY: Minecraft-Style Combat
- Simple click-to-attack (no charging mechanics)
- No dodge system (B button = Sprint)
- No bow & arrow (melee only for v0.6.0)
- Focus on responsive, instant feedback
- Easy to understand, hard to master

QUICK START CHECKLIST
=====================

PHASE 1: COMBAT FOUNDATION âœ… COMPLETE
---------------------------------------
[âœ…] Day 1-2: Combat System Core
    âœ… Created res://combat_system.gd (~300 lines)
    âœ… Created res://weapon.gd (Resource class)
    âœ… Added combat_attack input to project.godot
    âœ… Integrated with player.gd input handling
    âœ… Implemented camera shake system
    âœ… Added @export parameters for Inspector tuning

[âœ…] Day 3: Simple Attack System
    âœ… Single-shot attack (raycast, damage, cooldown)
    âœ… Targeting system with 30Â° auto-aim cone
    âœ… Simple crosshair (white=default, red=targeting)
    âœ… Created combat_ui.gd and combat_ui.tscn
    âœ… Camera shake + rumble feedback

[âœ…] Day 4: Weapons
    âœ… Defined 3 melee weapons (club/spear/sword)
    âœ… Weapon switching with RB button
    âœ… Crafting recipes in Weapon class
    âœ… Weapon stats: damage, range, cooldown

PHASE 2: ENEMIES (Week 2)
--------------------------
Day 5-6: Enemy Base Class
[ ] Create res://enemy.gd (extends CharacterBody3D)
[ ] State machine (Idle/Chase/Attack/Death)
[ ] Health system
[ ] Drop table system
[ ] Flash effects on damage
[ ] take_damage(amount) method (simplified - no is_heavy)

Day 7-9: Enemy Types (2 per day)
[ ] Corrupted Rabbit (territorial, fast, 30 HP)
[ ] Forest Goblin (patrol, flee at 20% HP, 50 HP)
[ ] Desert Scorpion (ambush, burrow, 60 HP)
[ ] Ice Wolf (pack AI, spawns in groups, 55 HP)
[ ] Stone Golem (tank, ground slam, 100 HP)
[ ] Shadow Wraith (night-only, floats, 40 HP)

Day 10: Spawning Integration
[ ] Extend critter_spawner.gd with enemy spawning
[ ] Biome-specific spawn logic
[ ] Pack spawning for Ice Wolves
[ ] Night-only logic for Shadow Wraith
[ ] Configure spawn rates (5-15% per chunk)

PHASE 3: AUDIO & VISUAL (Days 11-12)
-------------------------------------
Day 11: Audio Generation
[ ] Generate 8 player sounds via SFX Engine:
    - swing_light.wav
    - swing_medium.wav  
    - swing_heavy.wav
    - hit_flesh.wav
    - hit_stone.wav
    - player_grunt_1.wav
    - player_grunt_2.wav
    - player_death.wav
[ ] Generate 24 enemy sounds (4 per enemy Ã— 6 enemies)
[ ] Import to res://audio/combat/
[ ] Configure AudioManager entries
[ ] Test all sound triggers

Day 12: Textures & Effects
[ ] Generate 5 textures via Leonardo.ai
[ ] Apply to enemy materials
[ ] Create hit particle effects
[ ] Polish visual feedback
[ ] Finalize rumble presets

PHASE 4: INTEGRATION & POLISH (Day 13)
---------------------------------------
Day 13: Final Integration
[ ] Death system (detection, UI, respawn)
[ ] Balance pass (damage, HP, cooldowns)
[ ] Testing checklist
[ ] Bug fixes

FILE STRUCTURE
==============

âœ… Created Files:
-----------------
res://combat_system.gd              # Main combat logic (~300 lines)
res://weapon.gd                      # Weapon resource class
res://combat_ui.gd                   # Simple crosshair UI
res://combat_ui.tscn                 # UI scene (crosshair only)

Files to Create:
----------------
res://enemy.gd                       # Base enemy class
res://enemies/
    â”œâ”€â”€ corrupted_rabbit.gd + .tscn
    â”œâ”€â”€ forest_goblin.gd + .tscn
    â”œâ”€â”€ desert_scorpion.gd + .tscn
    â”œâ”€â”€ ice_wolf.gd + .tscn
    â”œâ”€â”€ stone_golem.gd + .tscn
    â””â”€â”€ shadow_wraith.gd + .tscn
res://ui/death_screen.tscn + .gd    # Death/respawn UI
res://audio/combat/                 # 32 combat sounds (8 player + 24 enemy)
res://textures/enemies/             # 5 AI-generated textures

âœ… Modified Files:
------------------
res://player.gd                     # Combat input integration
res://critter_spawner.gd            # Enemy spawning
res://health_hunger_system.gd       # Death detection
res://rumble_manager.gd             # Combat rumble presets
res://audio_manager.gd              # Combat sound entries
project.godot                       # combat_attack input mapping

CRITICAL CODE SNIPPETS
======================

1. âœ… INPUT ACTIONS (project.godot) - COMPLETE
-----------------------------------------------
combat_attack={
    "events": [
        InputEventMouseButton (button_index=1),
        InputEventJoypadMotion (axis=5, axis_value=1.0)  # RT
    ]
}

combat_dodge={  # Now used for SPRINT instead
    "events": [
        InputEventKey (keycode=32),              # Space
        InputEventJoypadButton (button_index=1)  # B
    ]
}

cycle_weapon={
    "events": [
        InputEventJoypadButton (button_index=5)  # RB
    ]
}

2. âœ… COMBAT SYSTEM CORE - COMPLETE
------------------------------------
extends Node
class_name CombatSystem

# Inspector-editable parameters
@export_group("Combat Timing")
@export_range(0.1, 2.0, 0.1) var attack_cooldown_duration: float = 0.5
@export_range(1.0, 10.0, 0.5) var attack_range: float = 3.0

@export_group("Targeting")
@export_range(0.0, 90.0, 5.0) var auto_aim_cone_angle: float = 30.0

# Combat state
var attack_cooldown: float = 0.0
var current_weapon: Weapon = null

func perform_attack():
    """Simple Minecraft-style attack"""
    if attack_cooldown > 0 or not current_weapon:
        return
    
    attack_cooldown = attack_cooldown_duration
    var target = raycast_for_enemy(current_weapon.attack_range)
    
    if target and target.has_method("take_damage"):
        target.take_damage(current_weapon.light_damage)
        shake_camera(0.5, 0.1)
        if RumbleManager:
            RumbleManager.play("medium")
    else:
        shake_camera(0.3, 0.08)
        if RumbleManager:
            RumbleManager.play("light")

3. ENEMY BASE SKELETON (TO CREATE)
-----------------------------------
extends CharacterBody3D
class_name Enemy

enum State { IDLE, CHASE, ATTACK, DEATH }

@export var max_health: int = 50
@export var damage: int = 10
@export var move_speed: float = 3.0
@export var detection_range: float = 10.0
@export var attack_range: float = 2.0

var current_state: State = State.IDLE
var current_health: int
var player: Node3D

func _ready():
    current_health = max_health
    add_to_group("enemies")
    player = get_tree().get_first_node_in_group("player")
    create_enemy_visual()

func update_ai(delta: float):
    var distance = global_position.distance_to(player.global_position)
    match current_state:
        State.IDLE:
            if distance < detection_range:
                current_state = State.CHASE
        State.CHASE:
            if distance < attack_range:
                current_state = State.ATTACK
            else:
                chase_player()

func take_damage(amount: int):
    """Simplified damage - no is_heavy parameter"""
    current_health -= amount
    flash_white()
    if current_health <= 0:
        die()

AI GENERATION COMMANDS
======================

AUDIO (SFX Engine):
-------------------
# Player Combat (8 sounds)
"Quick weapon whoosh, sharp and fast, light melee swing"
"Medium weapon swing, moderate speed and weight"
"Heavy powerful swing, deep whoosh with weight, strong attack"
"Meaty impact, flesh hit, satisfying thud"
"Rock impact, stone breaking, hard surface hit"
"Male player damage grunt, short pain sound, taking hit"
"Male player damage grunt variation, hit sound, different pitch"
"Male player death sound, final gasp, character dying"

# Enemy Sounds (4 per enemy Ã— 6 enemies = 24 sounds)
# Example - Corrupted Rabbit:
"Corrupted animal growl, hostile, low menacing"
"Rabbit attack hiss, aggressive lunge"
"Rabbit damage squeak, small animal hurt"
"Rabbit death squeal, final sound, small creature"

# Repeat pattern for: Goblin, Scorpion, Wolf, Golem, Wraith

TEXTURES (Leonardo.ai):
-----------------------
"Seamless tileable texture, corrupted animal fur, dark red-brown, diseased patches, matted, 512x512, top-down view, game texture"
"Seamless tileable texture, green goblin skin, mottled, warts, rough, fantasy game, 512x512, top-down view"
"Seamless tileable texture, scorpion chitin, sandy yellow, segmented plates, desert creature, 512x512, top-down view"
"Seamless tileable texture, white wolf fur, icy blue tint, frost patches, winter, 512x512, top-down view, game asset"
"Seamless tileable texture, granite stone, gray rock, orange glowing cracks, magma veins, 512x512, top-down view"

BALANCE REFERENCE
=================

PLAYER STATS:
Health: 100 HP
Move Speed: 5.0 m/s (walk), 10.0 m/s (sprint)
Attack Cooldown: 0.5s (configurable via Inspector)

WEAPON DAMAGE TABLE (SIMPLIFIED):
Weapon          | Damage | Cooldown | Range
----------------|--------|----------|-------
Wooden Club     |  15    |  1.0s    | 2.5m
Stone Spear     |  20    |  1.2s    | 3.5m
Bone Sword      |  25    |  1.0s    | 3.0m

ENEMY STATS TABLE:
Enemy            | HP  | DMG | Speed | Range | Hits to Kill (Club)
-----------------|-----|-----|-------|-------|--------------------
Corrupted Rabbit | 30  |  8  | 4.5   | 1.5m  | 2
Forest Goblin    | 50  | 12  | 3.0   | 2.0m  | 4
Desert Scorpion  | 60  | 15  | 3.0   | 2.5m  | 4  (SIMPLIFIED - buried AI removed)
Ice Wolf         | 55  | 14  | 4.5   | 2.0m  | 4
Stone Golem      | 100 | 20  | 1.5   | 2.5m  | 7
Shadow Wraith    | 40  | 12  | 4.0   | 2.0m  | 3  (MeshInstance visual, night checks disabled)

SPAWN RATES (per chunk):
Corrupted Rabbit: 15% (Forest)
Forest Goblin: 8% (Forest)
Desert Scorpion: 12% (Desert)
Ice Wolf: 10% (Snow, spawns in packs of 2-3)
Stone Golem: 5% (Mountains)
Shadow Wraith: 8% (All biomes, night only)

TESTING PROTOCOL
================

âœ… PHASE 1 TESTS (COMPLETE):
[âœ…] Attack works with M+KB (LMB)
[âœ…] Attack works with controller (RT)
[âœ…] Cooldown prevents spam
[âœ…] Crosshair changes to red when targeting
[âœ…] Camera shake on attack
[âœ…] Controller rumble on attack
[âœ…] Weapon switching works (RB)
[âœ…] B button triggers sprint (not dodge)
[âœ…] Combat system parameters visible in Inspector

PHASE 2 TESTS (UPCOMING):
[ ] All 6 enemy types spawn correctly
[ ] Enemy AI works (chase, attack, death)
[ ] Enemies take damage and die
[ ] Enemies drop items on death
[ ] Pack behavior for Ice Wolves
[ ] Shadow Wraith only spawns at night

PHASE 3 TESTS (UPCOMING):
[ ] All 32 sounds play correctly
[ ] Sound variation working
[ ] Enemy textures applied
[ ] Hit particles spawn
[ ] Visual effects polished

PHASE 4 TESTS (UPCOMING):
[ ] Player death detected at 0 HP
[ ] Death screen appears
[ ] Respawn works correctly
[ ] Items kept on death
[ ] No performance issues

COMMON PITFALLS
===============

1. âœ… ATTACK COOLDOWN SPAM - FIXED
   Solution: Check cooldown before allowing attack
   
2. âœ… CONTROLLER INPUT SPAM - FIXED
   Solution: Use is_action_pressed with echo check + charging flag
   
3. ENEMY STUCK IN WALLS
   Fix: Set collision_mask properly (Layer 1 only)
   
4. âœ… DESERT SCORPION TERRAIN CLIPPING - FIXED (Dec 13, 2024)
   Solution: Use CapsuleShape3D instead of BoxShape3D
   Note: CharacterBody3D optimized for capsule collision
   
5. âœ… SHADOW WRAITH INVISIBLE - FIXED (Dec 13, 2024)
   Solution: Use MeshInstance3D instead of CSG primitives
   Note: CSG doesn't render in Godot 4.5 runtime
   
6. âœ… FOREST GOBLIN FACING BACKWARDS - FIXED (Dec 13, 2024)
   Solution: Keep 180Â° visual rotation, add PI to look_at_player()
   Note: Removed duplicate back eyes geometry
   
7. CONTROLLER AUTO-AIM TOO STRONG
   Fix: Tune cone angle in Inspector (default: 30Â°)
   
8. SHADOW WRAITH SPAWNS AT DAY
   Fix: Check time_of_day properly (>= 0.9167 or < 0.25)
   Note: Currently disabled for v0.6.0 testing
   
9. ICE WOLVES DON'T PACK
   Fix: form_pack() called deferred in _ready()
   
10. STONE GOLEM TOO HARD
   Fix: Reduce HP or increase player damage via Inspector
   
11. SOUNDS NOT PLAYING
   Fix: Check AudioManager.play_sound() category parameter
   
12. âœ… B BUTTON CONFUSION - FIXED
   Solution: B button now = Sprint (was dodge)

ENEMY IMPLEMENTATION UPDATES (Dec 13, 2024)
============================================

DESERT SCORPION - SIMPLIFIED FOR v0.6.0:
----------------------------------------
REMOVED FEATURES:
- ScorpionState enum (BURIED, EMERGING, SURFACED, BURROWING)
- emerge_from_sand() function
- burrow_into_sand() function  
- check_for_emerge() function
- _physics_process() override
- Buried visibility toggling
- Position tweening for emerge/burrow
- Re-burrow after attack logic

CURRENT BEHAVIOR:
- Standard ground enemy (like rabbit/goblin)
- Always spawns surfaced and visible
- Chase â†’ Attack AI (no special states)
- CapsuleShape3D collision (radius 0.8, height 1.2)
- floor_snap_length = 0.5 (prevents terrain clipping)
- Tail strike with red telegraph flash (preserved)

REASON: Buried mechanics caused terrain clipping and state management issues.
DEFERRED TO: Future version (v0.7.0+)

SHADOW WRAITH - RENDERING FIX:
------------------------------
CHANGED:
- Visual: CSG primitives â†’ MeshInstance3D
- Reason: CSG doesn't render in Godot 4.5 runtime
- Night-only spawn checks temporarily disabled

IMPLEMENTATION:
var body = MeshInstance3D.new()
body.mesh = CylinderMesh.new()
var mat = StandardMaterial3D.new()
mat.transparency = BaseMaterial3D.TRANSPARENCY_ALPHA
mat.albedo_color = Color(0.5, 0.0, 0.8, 0.5)  # Purple, 50% alpha
body.material = mat

FOREST GOBLIN - ROTATION FIX:
-----------------------------
ISSUE: Goblin faced backwards during attack
CAUSE: visual_root rotated 180Â° for movement, but look_at() didn't compensate

SOLUTION:
func look_at_player() -> void:
    var to_player = player.global_position - global_position
    to_player.y = 0
    if to_player.length() > 0.01:
        var target_rotation = atan2(to_player.x, to_player.z)
        rotation.y = target_rotation + PI  # Add 180Â° compensation

ALSO REMOVED: Duplicate back eyes (lines 148-177)
- Someone had added 4 extra eyes on back of head
- Removed eye_back_left, eye_back_right, pupil_back_left, pupil_back_right

CORRUPTED RABBIT - HEIGHT FIX:
------------------------------
ISSUE: Spawning half-buried in ground
CAUSE: Collision shape center at Y=0.4, but visual parts at Y=0.0

SOLUTION: Raised ALL visual parts by +0.4m
- body.position: Y=0.0 â†’ Y=0.4
- head.position: Y=0.1 â†’ Y=0.5
- ears: Y=0.35 â†’ Y=0.75
- eyes: Y=0.15 â†’ Y=0.55
- tail: Y=0.05 â†’ Y=0.45

CSG RENDERING ISSUES:
--------------------
DISCOVERY: CSG primitives work in editor but don't render in runtime (Godot 4.5)
SOLUTION: Use MeshInstance3D for critical visual elements
APPLIED TO: Shadow Wraith

COLLISION SHAPE BEST PRACTICES:
-------------------------------
DISCOVERY: CharacterBody3D optimized for CapsuleShape3D, not BoxShape3D
ISSUE: BoxShape3D causes terrain clipping with sharp corners
SOLUTION: Always use CapsuleShape3D for moving enemies
APPLIED TO: Desert Scorpion (BoxShape â†’ CapsuleShape)

MATERIAL RENDERING FOR HOLLOW CSG:
----------------------------------
ISSUE: Eyes visible through back of head (CSG spheres are hollow)
SOLUTION: Add culling and transparency settings
head_mat.cull_mode = BaseMaterial3D.CULL_BACK
head_mat.transparency = BaseMaterial3D.TRANSPARENCY_DISABLED
APPLIED TO: Forest Goblin head material

PERFORMANCE TARGETS
===================

Target FPS: 60 (minimum)
Max Active Enemies: 12 simultaneously
Draw Calls: <100 with enemies
Memory: <500 MB
Load Time: <2 seconds

If performance issues:
1. Reduce enemy spawn rates
2. Use simpler particle effects
3. Lower texture resolution (256x256)
4. Cull distant enemies
5. Reduce max active enemies to 8

RELEASE CRITERIA
================

MUST HAVE:
âœ… Combat system functional (simple attack)
âœ… Crosshair UI working
âœ… Controller support complete
âœ… 4/6 enemy types debugged (Rabbit, Scorpion, Wraith, Goblin)
â³ Ice Wolf & Stone Golem testing remaining
â˜ Death/respawn working
â˜ No crashes or soft-locks
âœ… Audio playing correctly (32 sounds integrated)

SHOULD HAVE:
â˜ All 6 enemy types
â˜ All textures applied
â˜ All sounds integrated
â˜ Rumble working
â˜ Visual effects polished

NICE TO HAVE:
â—‹ Damage numbers
â—‹ Enemy ambient sounds
â—‹ Weapon durability

VERSION NUMBERING
=================

v0.6.0 - Initial simplified combat release
v0.6.1 - Bug fixes + polish
v0.6.2 - Balance adjustments
v0.7.0 - Next major feature (bosses/save system)

CHANGES FROM ORIGINAL PLAN
===========================

âœ… COMPLETED SIMPLIFICATIONS:
- Removed charging mechanics (was: hold 1.5s for heavy attack)
- Removed dodge system (was: B button dash with i-frames)
- Removed bow & arrow (was: charge-based ranged weapon)
- Removed charge UI (vignette, charge bar)
- Simplified to Minecraft-style click-to-attack
- B button remapped from Dodge to Sprint
- Made all combat parameters Inspector-editable
- Reduced total dev time from 48h to 32h

BENEFITS:
+ Simpler to implement
+ Easier to understand for players
+ More responsive combat feel
+ Fewer bugs to fix
+ Faster iteration on balance
+ Can always add complexity later if needed

SUPPORT RESOURCES
=================

Godot Docs: https://docs.godotengine.org/en/stable/
CharacterBody3D: https://docs.godotengine.org/en/stable/classes/class_characterbody3d.html
State Machines: https://gdquest.com/tutorial/godot/design-patterns/finite-state-machine/
Rumble API: https://docs.godotengine.org/en/stable/classes/class_input.html

GOOD LUCK! ðŸŽ®âš”ï¸
